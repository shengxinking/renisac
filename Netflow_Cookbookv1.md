# NetFlow Cookbook #

## Preface ##

Thank you for expressing interest in the NetFlow Cookbook. Click the link for the [Quick Start Version](https://code.google.com/p/renisac/wiki/DeploymentStrategies) of this manual. We hope our readers will find the content both helpful and informative. Our intent is simple, to provide our readers with a comprehensive manual on implementing and deploying NetFlow. Additionally, this manual extends well beyond the realm of NetFlow. Our goal is to make this manual a living and breathing document. Our hope is to encourage the community to expand on the content and delve into topics which will help operators to better defend their networks. Please feel free to submit any constructive feedback as we are looking to improve this manual in the future. Your feedback and contributions will help to make this the most comprehensive manual on NetFlow and traffic logging in existence.

## Prologue ##

Cyber attacks can occur without warning. In some cases, effective logging and controls can aid in preventing events before they transpire. Additionally, effective logging and traffic capturing measures are also required for compliance with laws and regulations such as [PCI DSS](http://en.wikipedia.org/wiki/Payment_Card_Industry_Data_Security_Standard),  [CALEA](http://en.wikipedia.org/wiki/Communications_Assistance_for_Law_Enforcement_Act), [FISMA](http://en.wikipedia.org/wiki/FISMA), [HIPAA](http://en.wikipedia.org/wiki/HIPAA), and [SOX](http://en.wikipedia.org/wiki/Sarbanes_Oxley). Keeping records of network traffic is an absolute requirement for incident response. However, if the collected data is not actionable, then it is effectively useless. For a Security Analyst, quality data is an absolute necessity in order to make informed decisions. One solution could be to setup a packet sniffer and call it a day. Well okay that works, but consider the following:

The amount of storage for packet capture on a fully saturated 1Gbps link can exceed
  * 1 day = 6TB
  * 1 week = 42TB
  * 1 month = 180TB

Additionally, querying such a vast amount of recorded packets could take hours or even days. Throwing additional capacity and/or storage at the problem may not be the best solution either. In this manual, we present leveraging flow data as a means of quickly indexing and looking up information for incident response. Tools which produce traffic flow information can substantially reduce the lookup times required for full packet capture from days to a matter of seconds. Rather than query through Terabytes of data, flow information can be used to efficiently  reduce overall search time. However, setting up such a system requires a structured and methodical approach. In **Figure A**, we present a tiered top-down structure for efficient traffic logging. In the following paragraphs, we discuss how each layer can be used to provide actionable intelligence as well as reduce the search time of terabytes worth of packet captures.

![http://www.ren-isac.net/img/googlecode/FlowHierarchy.jpg](http://www.ren-isac.net/img/googlecode/FlowHierarchy.jpg) <br>
<b>Figure A.</b> Tiered Model for Traffic Logging<br>
<br>
The cache layer is useful for narrowing your search down to a time window. A network forensic investigation could start at this most basic level, by gathering diagnostics, examining cache, and enabling logging on network routers, switches, servers, and firewall appliances. Information at this layer can provide a broad picture of the state of the network at a specific time. Routers and Switches view the network in a much different light compared to Servers or End-Users. They routinely gather statistics and build detailed reports of traffic conditions. Valuable information can be obtained just by gathering router and switch diagnostics. Everything from CPU, memory, buffer queues, and link utilization could provide insight as to whether an event is transpiring. One could also gather port statistics or gather information from sources such as the ARP cache, RIB/FIB, and syslog messages. Enabling SNMP and using centralized SNMP monitoring tools, such as Cacti, is also an effective means of gathering Cache data. There are many valuable gems to be found in the cache of networked devices.<br>
<br>
Once a time window for an event has been established using Cache data, one could then proceed to the NetFlow layer. NetFlow is a network protocol developed by Cisco Systems for collecting IP traffic information. It allows network devices to capture and record information about data flowing through the network. Unlike packet captures, NetFlow only captures session (Layer 3-5) information including source and destination IP and source and destination port. An example NetFlow implementation is illustrated in <b>Figure B</b>. NetFlow is fast becoming an industry standard for traffic monitoring because it's easy to deploy and supports various platforms. The growing popularity of Cisco NetFlow has prompted other network hardware vendors such as HP and Juniper to develop their own implementations of NetFlow, which are sFlow and J-Flow respectively. <b>Although, the  presented material in this manual takes a slant towards NetFlow, we do cover both sflow and J-Flow.</b> For a more detailed discussion on Netflow please refer to <a href='https://code.google.com/p/renisac/wiki/NetFlow?ts=1370356241&updated=NetFlow'>What is NetFlow?</a>. NetFlow is extremely useful for examining different flows of traffic throughout the network. A single flow can represent hundreds or even thousands of packets. When utilized to further drill down an incident, NetFlow provides a quick and effective method to quickly lookup the state of the network within a given window of time. This is extremely useful for reducing search time by identifying who was involved and what port/protocol was used.<br>
<br>
<img src='http://www.ren-isac.net/img/googlecode/MotivatingExamplev2.jpg' />

<b>Figure B.</b> An example of a potential NetFlow deployment.<br>
<br>
Subsequently, the AppFlow layer can further drill down and identify how the protocol was used. As the standard develops, we will expand on all sections of this manual related to AppFlow. Aside, from the section dedicated to AppFlow, we also discuss how AppFlow could potentially be implemented outside commercial offerings in Chapter 4. AppFlow is an evolution of the popular NetFlow protocol and is based on the IETF IPFIX protocol  <a href='http://tools.ietf.org/html/rfc5101'>RFC 5101</a> and <a href='http://tools.ietf.org/html/rfc5102'>RFC 5102</a>. Where NetFlow provides information on layers (3-5), AppFlow focuses on layers (4-7). It was first introduced by <a href='http://www.citrix.com/content/dam/citrix/en_us/documents/products/appflowuswp16830.pdf'>Citrix</a> in May, 2011 as an application performance monitoring tool. AppFlow is currently available as part of <a href='http://www.citrix.com/products/netscaler-application-delivery-controller/overview.html'>Citrix NetScalar</a>. Citrix is also pushing for AppFlow standardization and is continuing to gain momentum. AppFlow is still fairly new and the list of vendors who support AppFlow are slowly growing. In the broader context, we consider the AppFlow layer to include anything ranging from packet dissectors written in perl or python to commercial offerings such as AppFlow protocol. AppFlow data is useful for quickly looking up protocol and application specific information such as HTTP or SMTP messages. The aggregation and collection of all this data ultimately leads to the final layer of the model, the Packet Capture layer.<br>
<br>
In the previous paragraph's, we discussed how the Cache, NetFlow, and AppFlow layers can help quickly identify a timeframe, who was involved and on what port, as well as what applications were used and how they were used. However, the information gathered at each layers only tell a piece of the overall story. The Packet Capture layer provides the full picture. This is where a traffic recorder is employed using sniffing software such as tcpdump, wireshark, tshark and many others. With the information gathered in the previous layers, one can now better isolate what to look for in the raw packet captures. This approach can save a substantial amount of time when conducting a forensic network investigation. Full packet captures provide a fine granularity for information retrieval. As previously indicated, the storage required to retain packet captures can grow exponentially. As a result, captures should only be archived up to a certain threshold. Flow data leaves a substantially smaller footprint, thus, increasing the useful life of the information. As a result, information can be retained much longer than raw packet captures.<br>
<br>
<h2>Getting Started</h2>

<b>Note to Contributors:</b> Each item in the Table of Contents labeled <b>Part #</b> is considered a separate module. Multiple modules can fall under the same manual if they are related. Otherwise, the creation of separate modules are required. As the manual evolves, please updates to reflect any newly added content, including new modules. Lastly, refer to the <a href='https://code.google.com/p/renisac/wiki/NotetoContributors'>Note to Contributors</a> for information on requested pages/content and formatting guidelines.<br>
<br>
<h3>NetFlow Manual</h3>

This manual provides the groundwork to develop a NetFlow implementation plan. That's great! But where is the best place to start? In <b>Chapter 1</b>, we start with a detailed discussion on the NetFlow protocol.<br>
<br>
<h4>Important Concepts Covered</h4>
<ul><li><a href='https://code.google.com/p/renisac/wiki/NetFlow?ts=1370356241&updated=NetFlow#NetFlow_v5_and_NetFlow_v9_Differences'>NetFlow v5 and NetFlow v9 Differences</a>
</li><li><a href='https://code.google.com/p/renisac/wiki/NetFlow?ts=1370356241&updated=NetFlow#NetFlow_Collector'>NetFlow Collector</a>
</li><li><a href='https://code.google.com/p/renisac/wiki/NetFlow?ts=1370356241&updated=NetFlow#NetFlow_Probe/Exporter'>NetFlow Probe/Exporter</a>
</li><li><a href='https://code.google.com/p/renisac/wiki/NetFlow?ts=1370356241&updated=NetFlow#NetFlow_Analysis'>NetFlow Analysis</a></li></ul>

<b>Depending on your familiarity with NetFlow, you could skip straight to <a href='https://code.google.com/p/renisac/wiki/DeploymentStrategies?ts=1370391879&updated=DeploymentStrategies'>Chapter 1: Deployment Strategies</a>. All readers should begin by reviewing this section first.</b> This section discusses different deployment strategies for NetFlow implementation. This section also points to all other relevant sections of this manual for each deployment strategy.<br>
<br>
Now you have decided to implement NetFlow and have identified a deployment strategy which fits your needs; where should you go from here? As previously stated, the <a href='https://code.google.com/p/renisac/wiki/DeploymentStrategies?ts=1370391879&updated=DeploymentStrategies'>Deployment Strategies</a> section provides a map to the configuration guides for each deployment strategy. However, feel free to browse this guide in whatever order you like. In <b>Chapter 2</b>, we discuss the configuration steps utilized for the construction of our NetFlow testbed. In <b>Chapter 3</b>, we discuss the configuration steps for setting up NetFlow, sFlow, and J-Flow exporting on Cisco, HP, and Juniper devices. <b>Chapter 6</b> provides an introduction to NFSen and also covers the installation and deployment of an NFSen server. <b>Chapter 7</b> covers advanced features of NFSen. Topics include traffic classification, alert monitoring, and botnet detection. This chapter also includes installation and configuration guides for the NFSen botnet plugin.<br>
<br>
<h3>AppFlow Manual</h3>

<ul><li>Add to this section as the module on AppFlow develops. You may create a hub page for this module if you desire, just like in <a href='https://code.google.com/p/renisac/wiki/DeploymentStrategies?ts=1370391879&updated=DeploymentStrategies'>Deployment Strategies</a>. Just make sure to link back to the hub page from other WikiPages as specified in <a href='https://code.google.com/p/renisac/wiki/NotetoContributors'>Note to Contributors</a>. Also, please create a Quick Start version of each manual and add a hyperlink under the NetFlow version in the Table of contents. <b>Multiple modules can fall under the same manual if they are related.</b> Example:  <a href='https://code.google.com/p/renisac/wiki/DeploymentStrategies'>Quick Start NetFlow Manual</a>.</li></ul>

<h3>Packet Capture Manual</h3>

In <b>Chapter 5</b>, we address the concept of a Full Packet Capture (FPC) system. In this chapter, we also talk about ways in which to keep out of trouble, design considerations for a custom FPC system, and how to use tools such as tcpdump to create a custom FPC solution. We end this chapter by presenting fully comprehensive open source FPC solutions.<br>
<br>
<h3>Cache Layer Manual</h3>

<ul><li>Add to this section as the module on the Cache layer develops. You may create a hub page for this module if you desire, just like in <a href='https://code.google.com/p/renisac/wiki/DeploymentStrategies?ts=1370391879&updated=DeploymentStrategies'>Deployment Strategies</a>. Just make sure to link back to the hub page from other WikiPages as specified in <a href='https://code.google.com/p/renisac/wiki/NotetoContributors'>Note to Contributors</a>.  Also, please create a Quick Start version of each manual and add the hyperlink under the NetFlow version in the Table of contents. <b>Multiple modules can fall under the same manual if they are related.</b> Example:  <a href='https://code.google.com/p/renisac/wiki/DeploymentStrategies'>Quick Start NetFlow Manual</a>.